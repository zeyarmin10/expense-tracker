<div class="container mt-4 mb-5">
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">
      <div class="card shadow-sm p-3 p-md-4">
        <h2 class="card-title text-center mb-4">
          {{ editingExpenseId ? 'Edit Expense' : 'Add New Expense' }} (ကုန်ကျစရိတ်)
        </h2>

        <form [formGroup]="expenseForm" (ngSubmit)="onSubmit()">
          <div class="row">
            <div class="col-12 col-md-6 mb-3">
              <label for="date" class="form-label">ရက်စွဲ (Date)</label>
              <input
                type="date"
                class="form-control"
                id="date"
                formControlName="date"
                [class.is-invalid]="
                  expenseForm.controls['date'].invalid &&
                  expenseForm.controls['date'].touched
                "
              />
              <div
                *ngIf="
                  expenseForm.controls['date'].invalid &&
                  expenseForm.controls['date'].touched
                "
                class="invalid-feedback"
              >
                Date is required.
              </div>
            </div>

            <div class="col-12 col-md-6 mb-3">
              <label for="category" class="form-label">အမျိုးအစား (Category)</label>
              <select
                class="form-select"
                id="category"
                formControlName="category"
                [class.is-invalid]="
                  expenseForm.controls['category'].invalid &&
                  expenseForm.controls['category'].touched
                "
              >
                <option value="" disabled selected>Select a category</option>
                <option *ngFor="let cat of categories$ | async" [value]="cat.name">
                  {{ cat.name }}
                </option>
              </select>
              <div
                *ngIf="
                  expenseForm.controls['category'].invalid &&
                  expenseForm.controls['category'].touched
                "
                class="invalid-feedback"
              >
                Category is required.
              </div>
              <small *ngIf="(categories$ | async)?.length === 0" class="form-text text-muted">
                No categories available. Please add some on the Category page.
              </small>
            </div>
          </div>

          <div class="mb-3">
            <label for="itemName" class="form-label">ပစ္စည်းအမျိုးအမည် (Item Name)</label>
            <input
              type="text"
              class="form-control"
              id="itemName"
              formControlName="itemName"
              placeholder="e.g., ထမင်း, ရေသန့်"
              [class.is-invalid]="
                expenseForm.controls['itemName'].invalid &&
                expenseForm.controls['itemName'].touched
              "
            />
            <div
              *ngIf="
                expenseForm.controls['itemName'].invalid &&
                expenseForm.controls['itemName'].touched
              "
              class="invalid-feedback"
            >
              Item name is required.
            </div>
          </div>

          <div class="row">
            <div class="col-12 col-md-4 mb-3">
              <label for="quantity" class="form-label">အရေအတွက် (Quantity)</label>
              <input
                type="number"
                class="form-control"
                id="quantity"
                formControlName="quantity"
                min="1"
                [class.is-invalid]="
                  expenseForm.controls['quantity'].invalid &&
                  expenseForm.controls['quantity'].touched
                "
              />
              <div
                *ngIf="
                  expenseForm.controls['quantity'].invalid &&
                  expenseForm.controls['quantity'].touched
                "
                class="invalid-feedback"
              >
                Quantity must be at least 1.
              </div>
            </div>

            <div class="col-12 col-md-4 mb-3">
              <label for="unit" class="form-label">ယူနစ် (Unit)</label>
              <input
                type="text"
                class="form-control"
                id="unit"
                formControlName="unit"
                placeholder="e.g., ပွဲ, ဘူး, ကီလို"
                [class.is-invalid]="
                  expenseForm.controls['unit'].invalid &&
                  expenseForm.controls['unit'].touched
                "
              />
              <div
                *ngIf="
                  expenseForm.controls['unit'].invalid &&
                  expenseForm.controls['unit'].touched
                "
                class="invalid-feedback"
              >
                Unit is required.
              </div>
            </div>

            <div class="col-12 col-md-4 mb-3">
              <label for="price" class="form-label">ဈေးနှုန်း (Price)</label>
              <input
                type="number"
                class="form-control"
                id="price"
                formControlName="price"
                min="0"
                [class.is-invalid]="
                  expenseForm.controls['price'].invalid &&
                  expenseForm.controls['price'].touched
                "
              />
              <div
                *ngIf="
                  expenseForm.controls['price'].invalid &&
                  expenseForm.controls['price'].touched
                "
                class="invalid-feedback"
              >
                Price must be a non-negative number.
              </div>
            </div>
          </div>

          <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
            {{ errorMessage }}
          </div>
          <div *ngIf="successMessage" class="alert alert-success" role="alert">
            {{ successMessage }}
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="expenseForm.invalid"
            >
              <fa-icon [icon]="editingExpenseId ? faSave : faPlus"></fa-icon>
              {{ editingExpenseId ? ' Update' : ' Add' }} Expense
            </button>
            <button
              *ngIf="editingExpenseId"
              type="button"
              class="btn btn-secondary"
              (click)="cancelEdit()"
            >
              <fa-icon [icon]="faTimes"></fa-icon> Cancel
            </button>
          </div>
        </form>

        <hr class="my-4" />

        <h3 class="h5 text-center mb-3">Your Expenses</h3>
        <div *ngIf="(expenses$ | async)?.length === 0" class="alert alert-info text-center">
            No expenses recorded yet. Add one above!
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Item</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let expense of expenses$ | async">
                <td>{{ expense.date }}</td>
                <td>{{ expense.category }}</td>
                <td>{{ expense.itemName }}</td>
                <td>{{ expense.quantity }}</td>
                <td>{{ expense.unit }}</td>
                <td>{{ expense.price | currency:'USD':'symbol':'1.0-2' }}</td>
                <td>{{ expense.totalCost | currency:'USD':'symbol':'1.0-2' }}</td>
                <td>
                  <button
                    class="btn btn-sm btn-outline-info me-2"
                    (click)="startEdit(expense)"
                    [disabled]="editingExpenseId === expense.id"
                    aria-label="Edit"
                  >
                    <fa-icon [icon]="faEdit"></fa-icon>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-danger"
                    (click)="onDelete(expense.id!);"
                    aria-label="Delete"
                  >
                    <fa-icon [icon]="faTrash"></fa-icon>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>