<div class="container mt-4 mb-5">
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">
      <div class="card shadow-sm p-3 p-md-4">
        <h2 class="card-title text-center mb-4">Add New Expense (ကုန်ကျစရိတ်)</h2>
        <form [formGroup]="newExpenseForm" (ngSubmit)="onSubmitNewExpense()">
          <div class="row">
            <div class="col-12 col-md-6 mb-3">
              <label for="date" class="form-label">ရက်စွဲ (Date)</label>
              <input
                type="date"
                class="form-control"
                id="date"
                formControlName="date"
                [class.is-invalid]="
                  newExpenseForm.controls['date'].invalid &&
                  newExpenseForm.controls['date'].touched
                "
              />
              <div
                *ngIf="
                  newExpenseForm.controls['date'].invalid &&
                  newExpenseForm.controls['date'].touched
                "
                class="invalid-feedback"
              >
                Date is required.
              </div>
            </div>

            <div class="col-12 col-md-6 mb-3">
              <label for="category" class="form-label">အမျိုးအစား (Category)</label>
              <div class="input-group has-validation">
                <select
                  class="form-select"
                  id="category"
                  formControlName="category"
                  [class.is-invalid]="
                    newExpenseForm.controls['category'].invalid &&
                    newExpenseForm.controls['category'].touched
                  "
                  style="border-top-right-radius: 0;border-bottom-right-radius: 0;"
                >
                  <option value="" disabled selected>---Select a category---</option>
                  <option *ngFor="let cat of categories$ | async" [value]="cat.name">
                    {{ cat.name }}
                  </option>
                </select>
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  (click)="openCategoryModal()"
                  aria-label="Add new category"
                >
                  <fa-icon [icon]="faPlus"></fa-icon>
                </button>
              </div>
              <div
                *ngIf="
                  newExpenseForm.controls['category'].invalid &&
                  newExpenseForm.controls['category'].touched
                "
                class="invalid-feedback d-block"
              >
                Category is required.
              </div>
              <small *ngIf="(categories$ | async)?.length === 0" class="form-text text-muted">
                No categories available. Please add some on the Category page.
              </small>
            </div>
          </div>

          <div class="mb-3">
            <label for="itemName" class="form-label">ပစ္စည်းအမျိုးအမည် (Item Name)</label>
            <input
              type="text"
              class="form-control"
              id="itemName"
              formControlName="itemName"
              placeholder="e.g., ထမင်း, ရေသန့်"
              [class.is-invalid]="
                newExpenseForm.controls['itemName'].invalid &&
                newExpenseForm.controls['itemName'].touched
              "
            />
            <div
              *ngIf="
                newExpenseForm.controls['itemName'].invalid &&
                newExpenseForm.controls['itemName'].touched
              "
              class="invalid-feedback"
            >
              Item name is required.
            </div>
          </div>

          <div class="row">
            <div class="col-12 col-md-4 mb-3">
              <label for="quantity" class="form-label">အရေအတွက် (Quantity)</label>
              <input
                type="number"
                class="form-control"
                id="quantity"
                formControlName="quantity"
                min="1"
                [class.is-invalid]="
                  newExpenseForm.controls['quantity'].invalid &&
                  newExpenseForm.controls['quantity'].touched
                "
              />
              <div
                *ngIf="
                  newExpenseForm.controls['quantity'].invalid &&
                  newExpenseForm.controls['quantity'].touched
                "
                class="invalid-feedback"
              >
                Quantity must be at least 1.
              </div>
            </div>

            <div class="col-12 col-md-4 mb-3">
              <label for="unit" class="form-label">ယူနစ် (Unit)</label>
              <input
                type="text"
                class="form-control"
                id="unit"
                formControlName="unit"
                placeholder="e.g., ပွဲ, ဘူး, ကီလို"
                [class.is-invalid]="
                  newExpenseForm.controls['unit'].invalid &&
                  newExpenseForm.controls['unit'].touched
                "
              />
              <div
                *ngIf="
                  newExpenseForm.controls['unit'].invalid &&
                  newExpenseForm.controls['unit'].touched
                "
                class="invalid-feedback"
              >
                Unit is required.
              </div>
            </div>

            <div class="col-12 col-md-4 mb-3">
              <label for="price" class="form-label">ဈေးနှုန်း (Price)</label>
              <div class="input-group has-validation">
                <input
                  type="number"
                  class="form-control"
                  id="price"
                  formControlName="price"
                  min="0"
                  [class.is-invalid]="
                    newExpenseForm.controls['price'].invalid &&
                    newExpenseForm.controls['price'].touched
                  "
                  placeholder="Price"
                  aria-label="Price"
                  style="border-top-right-radius: 0;border-bottom-right-radius: 0;"
                />
                <select
                  class="form-select"
                  id="currency"
                  formControlName="currency"
                  style="max-width: 25%;"
                  [class.is-invalid]="
                    newExpenseForm.controls['currency'].invalid &&
                    newExpenseForm.controls['currency'].touched
                  "
                  aria-label="Currency"
                >
                  <option value="" disabled>Select</option>
                  <option value="MMK">MMK</option>
                  <option value="USD">USD</option>
                  <option value="THB">THB</option>
                </select>
              </div>
              <div
                *ngIf="
                  newExpenseForm.controls['price'].invalid &&
                  newExpenseForm.controls['price'].touched
                "
                class="invalid-feedback d-block"
              >
                Price must be a non-negative number.
              </div>
              <div
                *ngIf="
                  newExpenseForm.controls['currency'].invalid &&
                  newExpenseForm.controls['currency'].touched
                "
                class="invalid-feedback d-block"
              >
                Currency is required.
              </div>
            </div>
          </div>

          <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
            {{ errorMessage }}
          </div>
          <div *ngIf="successMessage" class="alert alert-success" role="alert">
            {{ successMessage }}
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="newExpenseForm.invalid"
            >
              <fa-icon [icon]="faPlus"></fa-icon> Add Expense
            </button>
          </div>
        </form>

        <hr class="my-4" />

        <h3 class="h5 text-center mb-3">Your Expenses</h3>
        <div *ngIf="(expenses$ | async)?.length === 0" class="alert alert-info text-center">
            No expenses recorded yet. Add one above!
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Item</th>
                <th>Qty/Unit</th>
                <th>Price</th>
                <th>Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let expense of expenses$ | async">
                <tr *ngIf="editingExpenseId !== expense.id">
                  <td>{{ expense.date }}</td>
                  <td>{{ expense.category }}</td>
                  <td>{{ expense.itemName }}</td>
                  <td>{{ expense.quantity }} {{ expense.unit }}</td>
                  <td>{{ expense.price | currency:expense.currency:'symbol':'1.0-2' }}</td>
                  <td class="fw-bold">{{ expense.totalCost | currency:expense.currency:'symbol':'1.0-2' }}</td>
                  <td class="text-end">
                    <button
                      class="btn btn-sm btn-outline-info me-2 edit-btn"
                      (click)="startEdit(expense)"
                      aria-label="Edit"
                      [disabled]="editingExpenseId !== null" >
                      <fa-icon [icon]="faEdit"></fa-icon>
                    </button>
                    <button
                      class="btn btn-sm btn-outline-danger"
                      (click)="onDelete(expense.id!);"
                      aria-label="Delete"
                      [disabled]="editingExpenseId !== null"
                    >
                      <fa-icon [icon]="faTrash"></fa-icon>
                    </button>
                  </td>
                </tr>

                <tr *ngIf="editingExpenseId === expense.id && editingForm" [formGroup]="editingForm">
                  <td>
                    <input type="date" class="form-control form-control-sm" formControlName="date"
                    [class.is-invalid]="editingForm.controls['date'].invalid && editingForm.controls['date'].touched" />
                  </td>
                  <td>
                    <select class="form-select form-select-sm" formControlName="category"
                    [class.is-invalid]="editingForm.controls['category'].invalid && editingForm.controls['category'].touched" >
                      <option *ngFor="let cat of categories$ | async" [value]="cat.name">{{ cat.name }}</option>
                    </select>
                  </td>
                  <td>
                    <input type="text" class="form-control form-control-sm" formControlName="itemName"
                    [class.is-invalid]="editingForm.controls['itemName'].invalid && editingForm.controls['itemName'].touched" />
                  </td>
                  <td>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control" formControlName="quantity" min="1"
                        [class.is-invalid]="editingForm.controls['quantity'].invalid && editingForm.controls['quantity'].touched" />
                        <input type="text" class="form-control" formControlName="unit" placeholder="Unit"
                        [class.is-invalid]="editingForm.controls['unit'].invalid && editingForm.controls['unit'].touched" />
                    </div>
                  </td>
                  <td>
                    <div class="input-group input-group-sm">
                      <input type="number" class="form-control" formControlName="price" min="0"
                      [class.is-invalid]="editingForm.controls['price'].invalid && editingForm.controls['price'].touched" />
                      <select class="form-select" formControlName="currency" style="max-width: 50%;"
                      [class.is-invalid]="editingForm.controls['currency'].invalid && editingForm.controls['currency'].touched" >
                        <option value="MMK">MMK</option>
                        <option value="USD">USD</option>
                        <option value="THB">THB</option>
                      </select>
                    </div>
                  </td>
                  <td class="fw-bold">
                    {{ editingForm.value.price * editingForm.value.quantity | currency:editingForm.value.currency:'symbol':'1.0-2' }}
                  </td>
                  <td class="text-end">
                    <button
                      class="btn btn-sm btn-outline-success me-2 save-btn"
                      (click)="saveEdit()"
                      [disabled]="editingForm.invalid"
                      aria-label="Save"
                    >
                      <fa-icon [icon]="faSave"></fa-icon>
                    </button>
                    <button
                      class="btn btn-sm btn-outline-danger"
                      (click)="cancelEdit()"
                      aria-label="Cancel"
                    >
                      <fa-icon [icon]="faTimes"></fa-icon>
                    </button>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
        <div *ngIf="editingForm && editingForm.invalid && (editingForm.dirty || editingForm.touched)" class="alert alert-warning mt-3">
          Please correct the errors in the edited expense fields.
          <ul>
            <li *ngIf="editingForm.controls['date'].invalid && editingForm.controls['date'].touched">Date is required.</li>
            <li *ngIf="editingForm.controls['category'].invalid && editingForm.controls['category'].touched">Category is required.</li>
            <li *ngIf="editingForm.controls['itemName'].invalid && editingForm.controls['itemName'].touched">Item name is required.</li>
            <li *ngIf="editingForm.controls['quantity'].invalid && editingForm.controls['quantity'].touched">Quantity must be at least 1.</li>
            <li *ngIf="editingForm.controls['unit'].invalid && editingForm.controls['unit'].touched">Unit is required.</li>
            <li *ngIf="editingForm.controls['price'].invalid && editingForm.controls['price'].touched">Price must be a non-negative number.</li>
            <li *ngIf="editingForm.controls['currency'].invalid && editingForm.controls['currency'].touched">Currency is required.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<app-category-modal (categoryAdded)="loadCategories()"></app-category-modal>