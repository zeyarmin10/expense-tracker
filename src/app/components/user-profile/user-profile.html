<div class="container mt-3 mb-5">
  <div class="row d-flex justify-content-center">
    <div class="col-12 col-md-10 col-lg-8 container-column">
      <div class="card shadow-sm p-3 p-md-4 user-profile-card">
        <div class="card-body">
          <h2 class="card-title text-center mb-4">{{ 'USER_PROFILE_TITLE' | translate }}</h2>

          <!-- Loading/Error Messages -->
          <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>
          <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>

          <ng-container *ngIf="userDisplayData$ | async as userData">
            <form [formGroup]="userProfileForm" (ngSubmit)="onSubmit()">

              <!-- Profile Picture -->
              <div class="text-center mb-4">
                <ng-container *ngIf="userPhotoUrl$ | async as photoUrl; else defaultIcon">
                  <img [src]="photoUrl" alt="User Photo" class="profile-photo rounded-circle" (error)="onImageError()" *ngIf="!imageLoadError">
                  <fa-icon [icon]="faUserCircle" size="6x" class="text-secondary" *ngIf="imageLoadError"></fa-icon>
                </ng-container>
                <ng-template #defaultIcon>
                  <fa-icon [icon]="faUserCircle" size="6x" class="text-secondary"></fa-icon>
                </ng-template>
              </div>

              <!-- Display Name -->
              <div class="mb-3">
                <label for="displayName" class="form-label">{{ 'DISPLAY_NAME_LABEL' | translate }}</label>
                <input type="text" id="displayName" class="form-control" formControlName="displayName">
              </div>

              <!-- Email -->
              <div class="mb-3">
                <label class="form-label">{{ 'EMAIL_LABEL' | translate }}</label>
                <p class="form-control-static">{{ userData.email }}</p>
              </div>
              <!-- Member Since -->
              <div class="mb-3">
                <label class="form-label font-weight-bold"
                  ><strong
                    >{{ "MEMBER_SINCE_LABEL" | translate }}</strong
                  ></label
                >
                <p class="form-control-plaintext">
                  {{ formatLocalizedDate(userData.createdAt, "MMM d, yyyy") }}
                </p>
              </div>

              <!-- Language Selection -->
              <div class="mb-3">
                <label for="language" class="form-label">{{ 'SYSTEM_LANGUAGE_LABEL' | translate }}</label>
                <select id="language" class="form-select" [ngModel]="selectedLanguage" (ngModelChange)="onLanguageChange($event)" [ngModelOptions]="{standalone: true}">
                  <option value="en">English</option>
                  <option value="my">မြန်မာ</option>
                </select>
              </div>

              <!-- Currency Selection -->
              <div class="mb-3">
                  <label for="currency" class="form-label">{{ 'CURRENCY' | translate }}</label>
                  <select id="currency" class="form-select" formControlName="currency">
                      <option *ngFor="let currency of translatedCurrencies" [value]="currency.code">{{ currency.name }} ({{ currency.symbol }})</option>
                  </select>
              </div>

              <!-- Budget Period -->
              <div class="mb-3">
                <label for="budgetPeriod" class="form-label">{{ 'BUDGET_PERIOD_LABEL' | translate }}</label>
                <div class="input-group">
                  <select id="budgetPeriod" class="form-select" formControlName="budgetPeriod">
                    <option *ngFor="let period of translatedBudgetPeriods" [value]="period.code">
                      {{ period.name }}
                    </option>
                    <optgroup label="{{ 'BUDGET_PERIOD.CUSTOM' | translate }}" *ngIf="customBudgetPeriods.length > 0">
                      <option *ngFor="let period of customBudgetPeriods" [value]="period.id">
                        {{ period.name }}
                        <button class="btn btn-outline-danger" 
                                type="button" 
                                (click)="deleteCustomPeriod(userProfileForm.get('budgetPeriod')?.value, $event)">
                          <fa-icon [icon]="faTrash"></fa-icon>
                        </button>
                      </option>
                    </optgroup>
                  </select>
                  <button class="btn btn-outline-info" type="button" (click)="openBudgetPeriodModal()">
                    <fa-icon [icon]="faPlus"></fa-icon>
                  </button>
                </div>
              </div>

              <!-- Custom Date Range Display -->
              <div *ngIf="showCustomDateRange" class="row">
                <div class="col-6 mb-3">
                  <label for="budgetStartDate" class="form-label">{{ 'START_DATE_LABEL' | translate }}</label>
                  <input type="date" id="budgetStartDate" class="form-control" formControlName="budgetStartDate">
                </div>
                <div class="col-6 mb-3">
                  <label for="budgetEndDate" class="form-label">{{ 'END_DATE_LABEL' | translate }}</label>
                  <input type="date" id="budgetEndDate" class="form-control" formControlName="budgetEndDate">
                </div>
              </div>

              <!-- Save Button -->
              <div class="d-flex justify-content-end mt-3">
                <button
                  type="submit"
                  class="btn ps-4 pe-4"
                  [ngClass]="{
                    'btn-outline-info': true,
                    'shine-effect': userProfileForm.valid
                  }"
                  [disabled]="userProfileForm.invalid || !userProfileForm.dirty"
                >
                  <fa-icon [icon]="faSave"></fa-icon>
                </button>
              </div>
            </form>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>

<app-custom-budget-period-modal (periodSaved)="onPeriodSaved($event)"></app-custom-budget-period-modal>
